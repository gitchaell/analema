# =============================================================================
# ANALEMA SOLAR Y LUNAR - Sky Photographer Workflow
# =============================================================================
#
# Automated GitHub Actions workflow for capturing webcam screenshots.
#
# TIMEZONE CONFIGURATION:
# - This workflow runs in Bolivian time (America/La_Paz, UTC-4)
# - The TZ environment variable ensures the container runs in Bolivian time
# - Target location: Multiple (Defined in src/config/locations.ts)
#
# SCHEDULE:
# - Runs every hour at minute 0
# - The script checks if there's a capture scheduled within that hour (based on config)
# - If no capture is scheduled, it exits immediately to save resources
#
# =============================================================================

name: Sky Photographer - Scheduled Capture

on:
  schedule:
    # Run every hour at minute 0
    # The script will check if there's a capture scheduled this hour and wait for it
    # Cron format: minute hour day month weekday (GitHub uses UTC time)
    - cron: '0 * * * *'

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      force_capture:
        description: 'Force capture regardless of schedule (for testing)'
        required: false
        default: 'false'

# Permissions needed to push captured images back to the repository
permissions:
  contents: write

env:
  # CRITICAL: Set timezone to Bolivia (UTC-4)
  # This ensures all Date operations in Node.js use Bolivian time
  # The script relies on this to match scheduled times.
  TZ: 'America/La_Paz'

jobs:
  capture:
    runs-on: ubuntu-latest

    steps:
      # =========================================================================
      # STEP 1: Checkout Repository
      # =========================================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for proper git operations
          fetch-depth: 0

      # =========================================================================
      # STEP 2: Setup Node.js 20 with npm cache
      # =========================================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # =========================================================================
      # STEP 3: Cache Puppeteer Browser
      # Puppeteer downloads Chromium (~170MB), caching saves significant time
      # =========================================================================
      - name: Cache Puppeteer
        uses: actions/cache@v4
        with:
          path: ~/.cache/puppeteer
          key: puppeteer-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            puppeteer-${{ runner.os }}-

      # =========================================================================
      # STEP 4: Install Dependencies
      # =========================================================================
      - name: Install dependencies
        run: npm ci

      # =========================================================================
      # STEP 4: Display Timezone Info (Debug)
      # =========================================================================
      - name: Display timezone information
        run: |
          echo "=== Timezone Configuration ==="
          echo "TZ Environment Variable: $TZ"
          echo "System date: $(date)"
          echo "Bolivia time (should match above): $(TZ='America/La_Paz' date)"
          echo "=============================="

      # =========================================================================
      # STEP 5: Run Sky Photographer Script
      # Use 'npm run test' for immediate capture when force_capture is true
      # Use 'npm start' for scheduled capture (waits for scheduled time)
      # =========================================================================
      - name: Run Sky Photographer
        run: |
          if [ "${{ github.event.inputs.force_capture }}" == "true" ]; then
            echo "ðŸ§ª Force capture enabled - running test mode (immediate capture)"
            npm run test
          else
            echo "ðŸ“… Running scheduled mode (checks for captures this hour)"
            npm start
          fi
        env:
          TZ: 'America/La_Paz'

      # =========================================================================
      # STEP 6: Check for New Captures
      # =========================================================================
      - name: Check for new captures
        id: check_captures
        run: |
          if [ -d "captures" ] && [ "$(ls -A captures 2>/dev/null)" ]; then
            echo "has_captures=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¸ New captures found!"
            ls -la captures/
          else
            echo "has_captures=false" >> $GITHUB_OUTPUT
            echo "ðŸ“­ No new captures to commit."
          fi

      # =========================================================================
      # STEP 7: Commit and Push New Captures
      # Only runs if new capture files exist
      # =========================================================================
      - name: Commit and push captures
        if: steps.check_captures.outputs.has_captures == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add all new capture files
          git add captures/

          # Create commit with timestamp and timezone info
          CAPTURE_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          git commit -m "ðŸ“¸ Sky capture: ${CAPTURE_TIME} (Bolivia, UTC-4)" \
                     -m "Automated capture from webcam." \
                     -m "System timezone: America/La_Paz (Bolivia)"

          # Push to repository
          git push

          echo "âœ… Captures committed and pushed successfully!"
